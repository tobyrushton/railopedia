---
import Layout from '../layouts/Layout.astro'
import SearchFallback from '../components/SearchFallback.astro'
import JourneyWrapper from '../components/JourneyWrapper.astro'
import { Suspense } from 'simple-stack-stream/components'
import { getStationName } from '../utils/station'
// import data from '../../../../data/test.json'

export const prerender = false

// todo: error handle if no query params
const destination = Astro.url.searchParams.get('destination')
const origin = Astro.url.searchParams.get('origin')
const departure = Astro.url.searchParams.get('departure')
const returnDate = Astro.url.searchParams.get('return')

const outboundStation = getStationName(origin)
const inboundStation = getStationName(destination)

let validArgs = false
if (inboundStation && outboundStation && departure) {
    validArgs = true
}

const API_URL = (import.meta as unknown as { env: { API_URL: string } }).env.API_URL
const url = `${API_URL}/search?origin=${origin}&destination=${destination}&departure=${departure}`
---

<Layout title="Search">
    <main class="flex flex-col px-5 md:px-10 py-5 grow">
    {
        validArgs ? (
            <h1 class="text-xl font-bold">
                Searching from {outboundStation} to {inboundStation}
            </h1>
            <Suspense>
                <JourneyWrapper 
                    url={url} 
                    outboundStation={outboundStation} 
                    inboundStation={inboundStation}
                    departure={departure}
                    returnDate={returnDate}
                />
            </Suspense>
        ) : (
            <SearchFallback />
        )
    }
    </main>
</Layout>